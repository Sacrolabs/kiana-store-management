// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  output        = "../lib/generated/prisma"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Currency {
  EUR
  GBP
}

enum ExpenseStatus {
  RAISED
  PAID
}

enum UserRole {
  ADMIN
  USER
}

model User {
  id               String    @id @default(uuid())
  email            String    @unique
  name             String
  password         String
  role             UserRole  @default(USER)
  emailVerified    Boolean   @default(false) @map("email_verified")
  resetToken       String?   @map("reset_token")
  resetTokenExpiry DateTime? @map("reset_token_expiry")
  lastLoginAt      DateTime? @map("last_login_at")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  @@map("users")
}

model Store {
  id                  String     @id @default(uuid())
  name                String
  address             String?
  phone               String?
  managerName         String?    @map("manager_name")
  supportedCurrencies Currency[] @default([EUR]) @map("supported_currencies")
  defaultCurrency     Currency   @default(EUR) @map("default_currency")
  createdAt           DateTime   @default(now()) @map("created_at")
  updatedAt           DateTime   @updatedAt @map("updated_at")

  sales      Sale[]
  expenses   Expense[]
  attendance Attendance[]
  employees  StoreEmployee[]

  @@map("stores")
}

model Employee {
  id            String   @id @default(uuid())
  name          String
  email         String?
  phone         String?
  hourlyRateEur Decimal? @map("hourly_rate_eur") @db.Decimal(10, 2)
  hourlyRateGbp Decimal? @map("hourly_rate_gbp") @db.Decimal(10, 2)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  attendance Attendance[]
  stores     StoreEmployee[]

  @@map("employees")
}

model Vendor {
  id        String   @id @default(uuid())
  name      String
  contact   String?
  email     String?
  phone     String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  expenses Expense[]

  @@map("vendors")
}

model Sale {
  id       String   @id @default(uuid())
  storeId  String   @map("store_id")
  date     DateTime @default(now())
  currency Currency @default(EUR)

  // All amounts stored as integers (cents/pence)
  cash       Int @default(0)
  online     Int @default(0)
  delivery   Int @default(0)
  justEat    Int @default(0) @map("just_eat")
  mylocal    Int @default(0)
  creditCard Int @default(0) @map("credit_card")
  total      Int @default(0)

  notes     String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([storeId, currency, date])
  @@index([storeId, date])
  @@index([date])
  @@index([currency])
  @@map("sales")
}

model Expense {
  id       String        @id @default(uuid())
  storeId  String        @map("store_id")
  vendorId String        @map("vendor_id")
  currency Currency      @default(EUR)
  status   ExpenseStatus @default(RAISED)

  // Amount stored as integer (cents/pence)
  amount Int

  description String?
  expenseDate DateTime @default(now()) @map("expense_date")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  store  Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)
  vendor Vendor @relation(fields: [vendorId], references: [id], onDelete: Restrict)

  @@index([storeId, expenseDate])
  @@index([vendorId])
  @@index([currency])
  @@map("expenses")
}

model Attendance {
  id          String   @id @default(uuid())
  employeeId  String   @map("employee_id")
  storeId     String   @map("store_id")
  checkIn     DateTime @map("check_in")
  checkOut    DateTime @map("check_out")
  hoursWorked Decimal  @map("hours_worked") @db.Decimal(5, 2)
  currency    Currency @default(EUR)

  // Amount stored as integer (cents/pence)
  amountToPay Int @map("amount_to_pay")

  notes     String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  store    Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([employeeId, checkIn])
  @@index([storeId, checkIn])
  @@index([checkIn])
  @@index([currency])
  @@map("attendance")
}

model StoreEmployee {
  id         String   @id @default(uuid())
  storeId    String   @map("store_id")
  employeeId String   @map("employee_id")
  assignedAt DateTime @default(now()) @map("assigned_at")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  store    Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([storeId, employeeId])
  @@index([storeId])
  @@index([employeeId])
  @@map("store_employees")
}
